---
# tasks file for user_configuration

- name: Add authorized keys for user
  ansible.posix.authorized_key:
    user: "{{ user_data.name }}"
    key: "{{ item }}"
    state: present
  loop: "{{ user_data.ssh.authorized_key | default([]) }}"
  when: user_data.ssh.authorized_key is defined

- name: Create user directories
  ansible.builtin.file:
    path: "/home/{{ user_data.name }}/{{ item.path }}"
    state: directory
    mode: "{{ item.mode }}"
    owner: "{{ user_data.name }}"
    group: "{{ user_data.name }}"
  loop:
    - { path: '.venv', mode: '0755' }
    - { path: '.credentials', mode: '0700' }
  when: user_data.state != 'absent'

- name: Create .config/git directory
  ansible.builtin.file:
    path: "/home/{{ user_data.name }}/.config/git"
    state: directory
    mode: '0755'
    owner: "{{ user_data.name }}"
    group: "{{ user_data.name }}"

- name: Configure Git for user
  ansible.builtin.template:
    src: .gitconfig.j2
    dest: "/home/{{ user_data.name }}/.config/git/config"
    owner: "{{ user_data.name }}"
    group: "{{ user_data.name }}"
    mode: '0644'
  vars:
    user: "{{ user_data }}"

- name: Create primary git repository directory
  ansible.builtin.file:
    path: "/home/{{ user_data.name }}/repo_{{ user_data.git_repositories[0].name }}"
    state: directory
    mode: '0755'
    owner: "{{ user_data.name }}"
    group: "{{ user_data.name }}"

- name: Create secondary git repository directories
  ansible.builtin.file:
    path: "/home/{{ user_data.name }}/repo_{{ item.name }}"
    state: directory
    mode: '0755'
    owner: "{{ user_data.name }}"
    group: "{{ user_data.name }}"
  loop: "{{ user_data.git_repositories[1:] | default([]) }}"

- name: Create git config files for secondary repositories
  ansible.builtin.copy:
    content: |
      [user]
          email = {{ item.email }}
          name = {{ item.name }}
    dest: "/home/{{ user_data.name }}/.config/git/config-{{ item.name }}"
    owner: "{{ user_data.name }}"
    group: "{{ user_data.name }}"
    mode: '0644'
  loop: "{{ user_data.git_repositories[1:] | default([]) }}"
